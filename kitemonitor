#/bin/bash
set -x

EMAILFILE=/tmp/WINDMILLALARM

rm -rf $EMAILFILE


tty=$1

if [[ -z $tty ]]; then
   echo "USAGE: $0 <arduino tty eg. /dev/ttyACM0>"
   exit -1
fi

echo "configuring tty : $tty"
 
if ! stty -F $tty 115200 cs8 cread clocal
then
  echo "FAILED to configure $tty
  exit -1
fi

echo "opening $tty on fd 3"

if ! exec 3<> $tty; then 
  echo "FAILED to open $tty"
  exit -1
fi

echo "waiting for arduino to initialize"
sleep 1

echo "Monitoring $tty for ALARM"

tail -f <&3 | while read line
do
  echo $line

  if [[ ${line} =~ .*ALARM.* ]]; then
    echo ALARM FOUND sending email
    if [[ ! -a $EMAILFILE ]]; then
      echo -e "Subject: Windmill ALARM\n\n $(date) ALARM DETECTED\n\n.\n" \| ssmtp sam@sdappavoo.com 
      touch $EMAILFILE
    fi
  fi
done


